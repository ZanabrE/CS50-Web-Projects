{% extends "auctions/layout.html" %}

{% block body %}

    <div class="container">
        {% if message%}
            {% if updated %}
                <div class="alert alert-success" role="alert">
                    {{ message }}
                </div>
            {% else %}
                <div class="alert alert-danger" role="alert">
                    {{ message }}
                </div>
            {% endif %}
        {% endif %}
    </div>

    {% if not listing.isActive and user == listing.price.user %}
    <div class="alert alert-info" role="alert">
        This listing has ended. You won the auction with a bid of ${{ listing.price.amount }}!
    </div>
    {% endif %}

    <div class="row mb-4">
        {% if user.is_authenticated  and listing.isActive%}
            {% if isOwner %}
                <form action="{% url 'close_auction' listing.id %}" class="mb-4" method="POST">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Close Auction</button>
                </form>
            {% endif %}

            {% if isListingInWatchlist %}
                <form action="{% url 'remove_watchlist' listing.id %}" method="POST">
                    {% csrf_token %}
                    <button name="action" value="remove">Remove from Watchlist</button>
                </form>
            {% else %}
                <form action="{% url 'add_watchlist' listing.id %}" method="POST">
                    {% csrf_token %}
                    <button name="action" value="add">Add to Watchlist</button>
                </form>
            {% endif %}
        {% endif %}
    </div>

    <h2>Marvel Character: {{ listing.title }}</h2>
    <img src="{{ listing.imageUrl }}" class="img-fluid mb-4" alt="{{ listing.title }}">
    <p><strong>Description:</strong> {{ listing.description}}</p>
    <p><strong>Owner:</strong> {{ listing.owner}}</p>
    <p><strong>Price:</strong> ${{ listing.price.amount }}</p>

    {% if user.is_authenticated %}
        {% if listing.isActive %}
            <form action="{% url 'place_bid' id=listing.id %}" method="POST">
                {% csrf_token %}
                <div class="form-group">
                    <label for="bid_amount">Place a Bid:</label>
                    <input type="number" step="any" class="form-control" id="bid_amount" name="bid_amount" placeholder="Enter your bid" required>
                </div>
                <button type="submit" class="btn btn-primary">Place Bid</button>
            </form>
        {% else %}
            <div class="alert alert-info" role="alert">
                <strong>Warning:</strong> This listing has ended.
            </div>
        {% endif %}
    {% endif %}

    <h2>Comments</h2>
    {% if user.is_authenticated and listing.isActive %}
        <form action="{% url 'add_comment' id=listing.id %}" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label for="comment">Add a Comment:</label>
                <textarea class="form-control" id="comment" name="comment" rows="3" placeholder="Enter your comment here..." required></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Add Comment</button>
        </form>
    {% elif not listing.isActive %}
        <div class="alert alert-info" role="alert">
            <strong>Warning:</strong> This listing has ended. You cannot add comments.
        </div>
    {% endif %}

    <div class="mt-4">
        {% for comment in allComments %}
            <div class="card mb-2">
                <div class="card-body">
                    <p class="card-text">{{ comment.content }}</p>
                    <footer class="blockquote-footer">Comment by <cite title="Source Title">{{ comment.user }}</cite></footer>
                </div>
            </div>
        {% endfor %}
    </div>

{% endblock %}